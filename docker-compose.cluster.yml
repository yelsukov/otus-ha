version: '2.4'

services:
  consul:
    image: consul:1.9.4
    container_name: consul
    command: agent -server -ui -node=otus -bootstrap-expect=1 -client=0.0.0.0
    networks:
      - inner
    ports:
      - 8500:8500
      - 8600:8600/udp

  node01:
    container_name: "node01"
    build:
      context: backend
    restart: always
    environment:
      JWT_SECRET: "${JWT_SECRET}"
      DB_HOST: "haproxy"
      DB_USER: "${MASTER_USER}"
      DB_PASSWORD: "${MASTER_PASSWORD}"
      DB_NAME: "${DB_NAME}"
      BUS_DSN: "${BUS_DSN}"
      BUS_TOPIC: "${BUS_TOPIC}"
      DEBUG: "${DEBUG}"
      NEWS_TOKEN: "${NEWS_TOKEN}"
      NEWS_URL: "news:${NEWS_PORT}"
      DIALOG_TOKEN: "${DIALOG_TOKEN}"
      DIALOG_NAME: "dialogue"
      DIALOG_HOSTS: "http://dialogue01:${DIALOG_PORT},http://dialogue02:${DIALOG_PORT}"
      CONSUL_DSN: "consul:8500"
      MIGRATIONS_HOST: "master_db"
      MIGRATIONS_USER: "${MASTER_USER}"
      MIGRATIONS_PASS: "${MASTER_PASSWORD}"
    networks:
      - inner
      - storage
      - queue
      - entry

  node02:
    container_name: "node02"
    build:
      context: backend
    restart: always
    environment:
      JWT_SECRET: "${JWT_SECRET}"
      DB_HOST: "haproxy"
      DB_USER: "${MASTER_USER}"
      DB_PASSWORD: "${MASTER_PASSWORD}"
      DB_NAME: "${DB_NAME}"
      BUS_DSN: "${BUS_DSN}"
      BUS_TOPIC: "${BUS_TOPIC}"
      DEBUG: "${DEBUG}"
      NEWS_TOKEN: "${NEWS_TOKEN}"
      NEWS_URL: "news:${NEWS_PORT}"
      DIALOG_TOKEN: "${DIALOG_TOKEN}"
      DIALOG_NAME: "dialogue"
      DIALOG_HOSTS: "http://dialogue01:${DIALOG_PORT},http://dialogue02:${DIALOG_PORT}"
      CONSUL_DSN: "consul:8500"
      SLAVE: "true"
    depends_on:
      - node01
    networks:
      - inner
      - storage
      - queue
      - entry

  nginx:
    image: nginx:1.19.6-alpine
    container_name: nginx
    restart: on-failure
    volumes:
      - ./deployment/nginx/nginx.conf:/etc/nginx/nginx.conf
    ports:
      - 80:80
    depends_on:
      - node01
      - node02
    networks:
      - entry

networks:
  queue:
    name: queue
    external: true
  storage:
    name: storage
    external: true
  inner:
    name: inner
  entry:
    name: entry